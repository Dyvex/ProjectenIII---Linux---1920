- name: Enable Software Collections
  yum:
    name: centos-release-scl-rh
    state: present

- name: Install php packages necessary for drupal 8
  yum:
    name: "{{ item }}"
    state: present
  loop: "{{ php_packages }}"

- name: Copy www.conf
  copy:
    src: www.conf
    dest: /etc/opt/rh/rh-php72/php-fpm.d/www.conf
  notify:
    - restart php-fpm

- name: Get composer installer
  get_url:
    url: "{{ composer_url }}"
    dest: "/tmp/composer-setup.php"
    checksum: "{{ composer_checksum }}"

- name: Install composer
  shell: "scl enable rh-php72 bash && php /tmp/composer-setup.php --install-dir={{ composer_path }} --filename=composer"

- name: Create drupal directory
  file:
    path: "{{ drupal_directory }}"
    state: directory

- name: Create drupal project with composer
  shell: "scl enable rh-php72 bash && composer create-project -y {{ drupal_version }} {{ drupal_directory }} --no-interaction"
  args:
    chdir: "{{ drupal_directory }}"

- name: Install drupal
  command: "scl enable rh-php72 bash && {{ drupal_directory }}/vendor/bin/drush --root={{ drupal_directory }} site-install -y --site-name={{ drupal_site }} --account-name={{ drupal_account_name }} --account-pass={{ drupal_account_pass }} --db-url=mysql://{{ database_user }}:{{ database_password }}@{{ database_host }}/{{ database }}"
  args:
    chdir: "{{ drupal_directory }}"
